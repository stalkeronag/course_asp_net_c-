# Аутентификация и авторизация

Аутентификация (Authentication) и авторизация (Authorization) - это два важных понятия в информационной безопасности.
Они связаны с процессом проверки подлинности пользователей и управления их доступом к ресурсам системы.

Аутентификация - это процесс проверки подлинности пользователя и подтверждения его личности. Это означает, что система
проверяет, является ли пользователь тем, кем он утверждает, что является. Обычно аутентификация осуществляется путем
запроса у пользователя идентификационных данных, таких как логин и пароль. Система затем проверяет эти данные на
действительность и, если они верны, присваивает пользователю статус &laquo;аутентифицированного&raquo;.

Авторизация - это процесс определения, имеет ли пользователь право доступа к определенному ресурсу или действию. Это
означает, что система проверяет, разрешено ли пользователю выполнять определенное действие или получать доступ к
определенному ресурсу. Обычно авторизация осуществляется путем проверки прав доступа, назначенных пользователю или
группе пользователей.

Отличие между аутентификацией и авторизацией заключается в том, что аутентификация устанавливает личность пользователя,
а авторизация определяет его права доступа. То есть, аутентификация проверяет, кто вы такой, а авторизация определяет,
что вы можете делать.

Обычно в процессе аутентификации пользователь должен предоставить свои идентификационные данные, которые затем
проверяются на соответствие хранимым в системе данным. Если аутентификация прошла успешно, пользователь может быть
авторизован для выполнения определенных действий или получения доступа к определенным ресурсам. Авторизация, в свою
очередь, обычно основана на правах доступа, которые назначаются пользователю или группе пользователей системным
администратором или другими уполномоченными лицами.

### JWT

[JWT (JSON Web Token)](https://jwt.io/) - это стандарт для представления данных в формате JSON, используемый для
передачи утверждений между
двумя сторонами. JWT состоит из трех частей: заголовка, полезной нагрузки и подписи. Он может использоваться для
аутентификации и авторизации пользователей в веб-приложениях и API.

Заголовок содержит информацию о типе токена (JWT) и алгоритме, используемом для его подписи. Обычно используется
алгоритм HMAC SHA256 или RSA.

Полезная нагрузка содержит утверждения, которые определяют свойства токена, такие как идентификатор пользователя, срок
действия токена и роли пользователя.

Подпись создается путем хеширования заголовка и полезной нагрузки с использованием ключа подписи. Подпись позволяет
проверить, что токен был создан авторизованным пользователем и не был изменен в процессе передачи.

JWT имеет ряд преимуществ по сравнению с традиционной системой аутентификации, в которой пользователь отправляет логин и
пароль на сервер для каждого запроса. Одно из основных преимуществ JWT заключается в том, что он может быть использован
для передачи утверждений между различными доменами, что делает его полезным для разработки распределенных систем.

Кроме того, JWT легко масштабируется и не требует хранения состояния на сервере, так как все необходимые данные хранятся
в токене. Это делает JWT особенно полезным для создания API, которые могут быть использованы различными клиентами, в том
числе мобильными приложениями и веб-приложениями.

В ASP.NET Core JWT может быть использован для аутентификации и авторизации пользователей с помощью пакета
`Microsoft.AspNetCore.Authentication.JwtBearer`. Этот пакет предоставляет middleware для проверки токена на каждом
запросе
и атрибуты авторизации для ограничения доступа к действиям в вашем приложении на основе ролей пользователя или других
правил доступа.

### JWT в ASP.NET Core

Для использования схемы аутентификации и авторизации на основе JWT на основе JWT в ConfigureServices методе Startup
класса можно настроить сервисы
аутентификации и авторизации следующим образом:

```csharp
services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true,
        ValidateAudience = true,
        ValidateLifetime = true,
        ValidateIssuerSigningKey = true,
        ValidIssuer = Configuration["Jwt:Issuer"],
        ValidAudience = Configuration["Jwt:Audience"],
        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(Configuration["Jwt:Key"]))
    };
});
```

Далее в Configure методе Startup класса необходимо добавить middleware для проверки токена:

```csharp
app.UseAuthentication();
```

После добавления middleware для проверки токена, вы можете использовать атрибуты авторизации, чтобы ограничить доступ к
определенным действиям в вашем приложении на основе ролей пользователя или других правил доступа.

Например, можно использовать атрибут `[Authorize]` для ограничения доступа к действию только для аутентифицированных
пользователей:

```csharp
[Authorize]
public IActionResult SecretAction()
{
    return Ok("This is a secret action.");
}
```

Можно также использовать атрибут [Authorize(Roles = "Admin")] для ограничения доступа только для пользователей, имеющих роль "Admin":

```csharp
[Authorize(Roles = "Admin")]
public IActionResult AdminAction()
{
    return Ok("This is an admin action.");
}
```

## Практика

- Настройте [схему аутентификации на основе JWT-токенов](https://metanit.com/sharp/aspnet6/13.2.php).
- Реализуйте методы API, которые мы пропустили ранее:
    - `Cart`
    - `Comment`
    - `Order`
    - `User`
-

Добавтье [схему аутентификации в Swagger UI](https://github.com/domaindrivendev/Swashbuckle.AspNetCore#add-security-definitions-and-requirements).

## Теория

- [Общие сведения о проверке подлинности в ASP.NET Core](https://learn.microsoft.com/ru-ru/aspnet/core/security/authentication/?view=aspnetcore-7.0)
- [Общие сведения о авторизации в ASP.NET Core](https://learn.microsoft.com/ru-ru/aspnet/core/security/authorization/introduction?view=aspnetcore-7.0)
- [Документация по платформе удостоверений Майкрософт (Microsoft Identity)](https://learn.microsoft.com/ru-ru/azure/active-directory/develop/)
- [Введение в аутентификацию и авторизацию на Metanit](https://metanit.com/sharp/aspnet6/13.1.php)
- [Swagger: Add Security Definitions and Requirements](https://github.com/domaindrivendev/Swashbuckle.AspNetCore#add-security-definitions-and-requirements)
- [Аутентификация и авторизация на платформе ASP.NET Core](https://www.youtube.com/watch?v=hFwIAPG6V4I&ab_channel=DotNext)
- [Playground для JWT-токенов](https://jwt.io/)
